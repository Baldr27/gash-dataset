<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Actions Workflow Vulnerability Analysis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        .stats-card {
            text-align: center;
            padding: 20px;
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .stats-label {
            font-size: 1rem;
            color: #6c757d;
        }
        .positive-correlation {
            color: #dc3545;
        }
        .negative-correlation {
            color: #198754;
        }
        .no-correlation {
            color: #6c757d;
        }
        .trend-indicator {
            font-size: 1.5rem;
            margin-left: 10px;
        }
        .analysis-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">GitHub Actions Workflow Analysis</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="analysis-section">
                    <h2>Workflow Metadata vs. Vulnerability Analysis</h2>
                    <p>This dashboard analyzes the relationship between workflow characteristics (line count, number of jobs, steps) and security vulnerabilities.</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-number" id="totalFindings">0</div>
                    <div class="stats-label">Total Findings</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-number" id="avgLineCount">0</div>
                    <div class="stats-label">Avg. Workflow Lines</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="stats-number" id="findingsPerLine">0</div>
                    <div class="stats-label">Findings per 100 Lines</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Line Count vs. Vulnerabilities</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="lineCountChart"></canvas>
                        </div>
                        <div id="lineCountAnalysis" class="analysis-result"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Number of Jobs vs. Vulnerabilities</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="jobsChart"></canvas>
                        </div>
                        <div id="jobsAnalysis" class="analysis-result"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Steps per Job vs. Vulnerabilities</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="stepsChart"></canvas>
                        </div>
                        <div id="stepsAnalysis" class="analysis-result"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Workflow Evolution Over Time</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select id="repoSelect" class="form-select">
                                    <option value="">Select Repository</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select id="workflowSelect" class="form-select">
                                    <option value="">Select Workflow</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button id="analyzeBtn" class="btn btn-primary w-100">Analyze Evolution</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="evolutionChart"></canvas>
                        </div>
                        <div id="evolutionAnalysis" class="analysis-result"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Detailed Findings</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Repository</th>
                                        <th>Workflow</th>
                                        <th>Line Count</th>
                                        <th>Jobs</th>
                                        <th>Steps/Job</th>
                                        <th>Findings</th>
                                        <th>Findings/Line</th>
                                    </tr>
                                </thead>
                                <tbody id="findingsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/duckdb@0.9.2/dist/duckdb.js"></script>
    <script>
        // Initialize DuckDB
        let db = null;
        let conn = null;

        async function initDuckDB() {
            try {
                // Initialize DuckDB
                const JSDELIVR_CDN = 'https://cdn.jsdelivr.net/npm/duckdb@0.9.2/dist/duckdb.wasm';
                db = new DuckDB.Database('memory:', JSDELIVR_CDN);
                conn = db.connect();
                
                // Load parquet files
                await loadParquetFiles();
                
                // Initialize the dashboard
                await initializeDashboard();
                
            } catch (error) {
                console.error('Error initializing DuckDB:', error);
                alert('Error loading data: ' + error.message);
            }
        }

        async function loadParquetFiles() {
            try {
                // Load findings data
                await conn.query(`
                    CREATE TABLE findings AS 
                    SELECT * FROM parquet_scan('./data/findings.parquet')
                `);
                
                // Load metadata
                await conn.query(`
                    CREATE TABLE metadata AS 
                    SELECT * FROM parquet_scan('./data/workflow_metadata.parquet')
                `);
                
                console.log('Data loaded successfully');
            } catch (error) {
                console.error('Error loading parquet files:', error);
                throw error;
            }
        }

        async function initializeDashboard() {
            // Load repository list
            const repos = await conn.query(`
                SELECT DISTINCT repo_name FROM metadata ORDER BY repo_name
            `);
            
            const repoSelect = document.getElementById('repoSelect');
            repos.forEach(repo => {
                const option = document.createElement('option');
                option.value = repo.repo_name;
                option.textContent = repo.repo_name;
                repoSelect.appendChild(option);
            });
            
            // Update workflow list when repository changes
            repoSelect.addEventListener('change', async () => {
                const workflows = await conn.query(`
                    SELECT DISTINCT workflow_name FROM metadata 
                    WHERE repo_name = '${repoSelect.value}' 
                    ORDER BY workflow_name
                `);
                
                const workflowSelect = document.getElementById('workflowSelect');
                workflowSelect.innerHTML = '<option value="">Select Workflow</option>';
                
                workflows.forEach(workflow => {
                    const option = document.createElement('option');
                    option.value = workflow.workflow_name;
                    option.textContent = workflow.workflow_name;
                    workflowSelect.appendChild(option);
                });
            });
            
            // Set up analyze button
            document.getElementById('analyzeBtn').addEventListener('click', analyzeWorkflowEvolution);
            
            // Load initial visualizations
            await updateVisualizations();
        }

        async function updateVisualizations() {
            // Get aggregated data for visualizations
            const aggregatedData = await conn.query(`
                SELECT 
                    m.repo_name,
                    m.workflow_name,
                    m.version_ts,
                    m.line_count,
                    m.num_jobs,
                    m.steps_per_job,
                    COUNT(f.rule_id) as findings_count,
                    AVG(CAST(JSON_EXTRACT(m.steps_per_job, '$.total_steps') AS FLOAT)) as avg_steps_per_job
                FROM metadata m
                LEFT JOIN findings f ON 
                    m.repo_name = f.repo_name AND 
                    m.workflow_name = f.workflow_name AND 
                    m.version_ts = f.version_ts
                GROUP BY m.repo_name, m.workflow_name, m.version_ts, m.line_count, m.num_jobs, m.steps_per_job
            `);
            
            // Update stats
            document.getElementById('totalFindings').textContent = aggregatedData.reduce((sum, row) => sum + row.findings_count, 0);
            document.getElementById('avgLineCount').textContent = Math.round(aggregatedData.reduce((sum, row) => sum + row.line_count, 0) / aggregatedData.length);
            
            const totalLines = aggregatedData.reduce((sum, row) => sum + row.line_count, 0);
            const totalFindings = aggregatedData.reduce((sum, row) => sum + row.findings_count, 0);
            document.getElementById('findingsPerLine').textContent = (totalFindings / totalLines * 100).toFixed(2);
            
            // Create scatter plots
            createScatterPlot('lineCountChart', 
                aggregatedData.map(row => row.line_count),
                aggregatedData.map(row => row.findings_count),
                'Line Count',
                'Number of Vulnerabilities',
                'lineCountAnalysis',
                'line count'
            );
            
            createScatterPlot('jobsChart', 
                aggregatedData.map(row => row.num_jobs),
                aggregatedData.map(row => row.findings_count),
                'Number of Jobs',
                'Number of Vulnerabilities',
                'jobsAnalysis',
                'number of jobs'
            );
            
            createScatterPlot('stepsChart', 
                aggregatedData.map(row => row.avg_steps_per_job || 0),
                aggregatedData.map(row => row.findings_count),
                'Average Steps per Job',
                'Number of Vulnerabilities',
                'stepsAnalysis',
                'average steps per job'
            );
            
            // Update detailed table
            updateDetailedTable(aggregatedData);
        }

        function createScatterPlot(canvasId, xData, yData, xLabel, yLabel, analysisId, factorName) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Calculate correlation
            const correlation = calculateCorrelation(xData, yData);
            
            // Create scatter plot
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Workflows',
                        data: xData.map((x, i) => ({x, y: yData[i]})),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xLabel
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yLabel
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${xLabel}: ${context.raw.x}, ${yLabel}: ${context.raw.y}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Add correlation analysis
            const analysisElement = document.getElementById(analysisId);
            let analysisText = '';
            let correlationClass = 'no-correlation';
            
            if (Math.abs(correlation) > 0.5) {
                correlationClass = correlation > 0 ? 'positive-correlation' : 'negative-correlation';
                analysisText = `Strong ${correlation > 0 ? 'positive' : 'negative'} correlation (r=${correlation.toFixed(2)}) between ${factorName} and vulnerabilities. `;
                analysisText += `This suggests that workflows with higher ${factorName} tend to have ${correlation > 0 ? 'more' : 'fewer'} vulnerabilities.`;
            } else if (Math.abs(correlation) > 0.2) {
                correlationClass = correlation > 0 ? 'positive-correlation' : 'negative-correlation';
                analysisText = `Moderate ${correlation > 0 ? 'positive' : 'negative'} correlation (r=${correlation.toFixed(2)}) between ${factorName} and vulnerabilities.`;
            } else {
                analysisText = `Weak correlation (r=${correlation.toFixed(2)}) between ${factorName} and vulnerabilities. No strong relationship detected.`;
            }
            
            analysisElement.innerHTML = `<div class="${correlationClass}">${analysisText}</div>`;
        }

        function calculateCorrelation(x, y) {
            // Calculate means
            const meanX = x.reduce((sum, val) => sum + val, 0) / x.length;
            const meanY = y.reduce((sum, val) => sum + val, 0) / y.length;
            
            // Calculate covariance and variances
            let covariance = 0;
            let varianceX = 0;
            let varianceY = 0;
            
            for (let i = 0; i < x.length; i++) {
                covariance += (x[i] - meanX) * (y[i] - meanY);
                varianceX += Math.pow(x[i] - meanX, 2);
                varianceY += Math.pow(y[i] - meanY, 2);
            }
            
            // Calculate correlation coefficient
            return covariance / Math.sqrt(varianceX * varianceY);
        }

        async function analyzeWorkflowEvolution() {
            const repo = document.getElementById('repoSelect').value;
            const workflow = document.getElementById('workflowSelect').value;
            
            if (!repo || !workflow) {
                alert('Please select both a repository and a workflow');
                return;
            }
            
            // Get evolution data
            const evolutionData = await conn.query(`
                SELECT 
                    m.version_ts,
                    m.line_count,
                    m.num_jobs,
                    m.steps_per_job,
                    COUNT(f.rule_id) as findings_count,
                    AVG(CAST(JSON_EXTRACT(m.steps_per_job, '$.total_steps') AS FLOAT)) as avg_steps_per_job
                FROM metadata m
                LEFT JOIN findings f ON 
                    m.repo_name = f.repo_name AND 
                    m.workflow_name = f.workflow_name AND 
                    m.version_ts = f.version_ts
                WHERE m.repo_name = '${repo}' AND m.workflow_name = '${workflow}'
                GROUP BY m.version_ts, m.line_count, m.num_jobs, m.steps_per_job
                ORDER BY m.version_ts
            `);
            
            if (evolutionData.length === 0) {
                alert('No data available for this workflow');
                return;
            }
            
            // Create evolution chart
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            const dates = evolutionData.map(row => new Date(row.version_ts).toLocaleDateString());
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Line Count',
                            data: evolutionData.map(row => row.line_count),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            yAxisID: 'y',
                            fill: true
                        },
                        {
                            label: 'Vulnerabilities',
                            data: evolutionData.map(row => row.findings_count),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            yAxisID: 'y1',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Line Count'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Vulnerabilities'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // Calculate trends
            const lineTrend = calculateTrend(evolutionData.map((row, i) => i), evolutionData.map(row => row.line_count));
            const vulnTrend = calculateTrend(evolutionData.map((row, i) => i), evolutionData.map(row => row.findings_count));
            
            // Generate analysis
            let analysisText = `<h4>Evolution Analysis for ${repo} / ${workflow}</h4>`;
            
            if (lineTrend.slope > 0.1) {
                analysisText += `<p class="positive-correlation">Line count has increased over time (slope: ${lineTrend.slope.toFixed(2)})</p>`;
            } else if (lineTrend.slope < -0.1) {
                analysisText += `<p class="negative-correlation">Line count has decreased over time (slope: ${lineTrend.slope.toFixed(2)})</p>`;
            } else {
                analysisText += `<p class="no-correlation">Line count has remained relatively stable (slope: ${lineTrend.slope.toFixed(2)})</p>`;
            }
            
            if (vulnTrend.slope > 0.1) {
                analysisText += `<p class="positive-correlation">Vulnerabilities have increased over time (slope: ${vulnTrend.slope.toFixed(2)})</p>`;
            } else if (vulnTrend.slope < -0.1) {
                analysisText += `<p class="negative-correlation">Vulnerabilities have decreased over time (slope: ${vulnTrend.slope.toFixed(2)})</p>`;
            } else {
                analysisText += `<p class="no-correlation">Vulnerabilities have remained relatively stable (slope: ${vulnTrend.slope.toFixed(2)})</p>`;
            }
            
            // Check if changes in line count correlate with changes in vulnerabilities
            const lineChanges = [];
            const vulnChanges = [];
            
            for (let i = 1; i < evolutionData.length; i++) {
                lineChanges.push(evolutionData[i].line_count - evolutionData[i-1].line_count);
                vulnChanges.push(evolutionData[i].findings_count - evolutionData[i-1].findings_count);
            }
            
            const changeCorrelation = calculateCorrelation(lineChanges, vulnChanges);
            
            if (Math.abs(changeCorrelation) > 0.5) {
                analysisText += `<p>There is a ${changeCorrelation > 0 ? 'strong positive' : 'strong negative'} correlation (r=${changeCorrelation.toFixed(2)}) between changes in line count and changes in vulnerabilities.</p>`;
            } else {
                analysisText += `<p>No strong correlation between changes in line count and changes in vulnerabilities (r=${changeCorrelation.toFixed(2)}).</p>`;
            }
            
            document.getElementById('evolutionAnalysis').innerHTML = analysisText;
        }

        function calculateTrend(x, y) {
            // Simple linear regression
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((a, val, i) => a + val * y[i], 0);
            const sumXX = x.reduce((a, b) => a + b * b, 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            return { slope, intercept };
        }

        function updateDetailedTable(data) {
            const tableBody = document.getElementById('findingsTable');
            tableBody.innerHTML = '';
            
            // Sort by findings per line (descending)
            const sortedData = [...data].sort((a, b) => {
                const aRatio = a.findings_count / a.line_count;
                const bRatio = b.findings_count / b.line_count;
                return bRatio - aRatio;
            });
            
            // Show top 20 workflows with highest vulnerability density
            sortedData.slice(0, 20).forEach(row => {
                const tr = document.createElement('tr');
                const stepsPerJob = row.avg_steps_per_job ? row.avg_steps_per_job.toFixed(1) : 'N/A';
                const findingsPerLine = (row.findings_count / row.line_count * 100).toFixed(2);
                
                tr.innerHTML = `
                    <td>${row.repo_name}</td>
                    <td>${row.workflow_name}</td>
                    <td>${row.line_count}</td>
                    <td>${row.num_jobs}</td>
                    <td>${stepsPerJob}</td>
                    <td>${row.findings_count}</td>
                    <td>${findingsPerLine}</td>
                `;
                
                tableBody.appendChild(tr);
            });
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', initDuckDB);
    </script>
</body>
</html>
